name: Research Structure Pipeline
id: research-structure
version: 2.0.0
author: ai-kod
description: Подготавливает окружение research-structure bundle и формирует файловые артефакты для последующих стадий
  (списки кода, документации и дерево директорий).
tags:
  - research
  - structure
  - analysis
metadata:
  description: Подготовительный этап research-structure bundle с формированием артефактов.
schemas:
  codeItem@1:
    type: object
    required:
      - path
      - relative_path
      - display_path
      - extension
      - size
      - index
    properties:
      path:
        type: string
        description: Абсолютный путь файла кода.
        format: path
        x-path:
          mode: input
          resolve:
            base: "{{workspace.references.PROJECT_ROOT}}"
            output: absolute
          require_inside_root: "{{workspace.references.PROJECT_ROOT}}"
          require_type: file
          require_exist: always
      relative_path:
        type: string
        description: Путь относительно корня проекта.
      display_path:
        type: string
        description: Отображаемый путь файла.
      extension:
        type: string
        description: Расширение файла.
      size:
        type: integer
        minimum: 0
      index:
        type: integer
        minimum: 0
      recorded_size:
        type: integer
        description: Размер, зафиксированный ранее.
  docItem@1:
    type: object
    required:
      - path
      - relative_path
      - display_path
      - extension
      - top_directory
      - index
    properties:
      path:
        type: string
        format: path
        x-path:
          mode: input
          resolve:
            base: "{{workspace.references.PROJECT_ROOT}}"
            output: absolute
          require_inside_root: "{{workspace.references.PROJECT_ROOT}}"
          require_type: file
          require_exist: always
      relative_path:
        type: string
      display_path:
        type: string
      extension:
        type: string
      top_directory:
        type: string
      index:
        type: integer
  processedDocumentList@1:
    type: array
    description: Список результатов обработки документов.
    items:
      type: object
  parallelLaneResult@1:
    type: object
    required:
      - lane_id
      - status
    properties:
      lane_id:
        type: string
      step_id:
        type: string
      status:
        type: string
      output_status:
        type: string
      outputs:
        type: object
        properties:
          status:
            type: string
          metrics:
            type: object
            additionalProperties: true
          deviations:
            type: array
            items:
              type: object
              additionalProperties: true
          artefacts:
            type: object
            additionalProperties: true
        additionalProperties: true
      error:
        type: object
        additionalProperties: true
      metadata:
        type: object
        additionalProperties: true
  parallelResults@1:
    type: object
    required:
      - code
      - docs
    properties:
      code:
        $ref: "#/schemas/parallelLaneResult@1"
      docs:
        $ref: "#/schemas/parallelLaneResult@1"
      order:
        type: array
        items:
          type: string
      lanes:
        type: object
        additionalProperties:
          $ref: "#/schemas/parallelLaneResult@1"
    additionalProperties: true
start: start
inputs:
  required:
    - name: project_root
      type: string
      description: Абсолютный путь к анализируемому репозиторию (обязательный).
  optional:
    - name: git_sha
      type: string
      description: Git SHA, связанный с прогоном (опционально).
      default: ""
    - name: remarks
      type: array
      description: Список REMARK объектов (JSON объекты с `path`, `scope`, `recursive`, `text`).
      default: []
packages:
  - name: research-scripts
    version: 0.4.0
stages:
  - id: start
    name: Prepare research structure context
    execution:
      kind: script
      script:
        package: research-scripts
        entry: workflow/bootstrap.mjs
        runtime: node20
    context_from:
      - bundle.project-analyse.scripts
      - bundle.project-analyse.workflows
      - bundle.project-analyse.fixtures
      - bundle.project-analyse.demo
      - bundle.project-analyse.demo.apps
      - bundle.project-analyse.demo.docs
      - bundle.project-analyse.config
      - bundle.project-analyse.docs
      - bundle.project-analyse.schemas
    workspace_contract:
      files:
        required:
          - glob: code-files.json
            expect:
              count: 1
            error: code-files.json не создан
          - glob: doc-files.json
            expect:
              count: 1
            error: doc-files.json не создан
          - glob: folder-tree.json
            expect:
              count: 1
            error: folder-tree.json не создан
          - glob: output.yaml
            expect:
              count: 1
            error: output.yaml отсутствует
    contracts:
      output:
        type: object
        required:
          - status
          - project_root
          - db_checks
          - metrics
        properties:
          status:
            type: string
          project_root:
            type: string
            format: path
            x-path:
              mode: output
              resolve:
                base: /
                output: absolute
              require_type: directory
              require_exist: always
          db_checks:
            type: object
            required:
              - sqlite_version
              - tables_count
              - indexes_count
              - run_registered
            properties:
              sqlite_version:
                type: string
              tables_count:
                type: integer
                minimum: 1
              indexes_count:
                type: integer
                minimum: 1
              run_registered:
                type: boolean
          metrics:
            type: object
            properties:
              code_files_count:
                type: integer
              doc_files_count:
                type: integer
              folder_count:
                type: integer
    navigation:
      strategy: linear
      next: lanes-parallel-start
  - id: lanes-parallel-start
    kind: parallel
    mode: start
    block: lanes-processing
    context_from:
      - start
    lanes:
      - id: code
        start: code-prepare
        endAt: code-summary
      - id: docs
        start: docs-prepare
        endAt: docs-summary
    navigation:
      strategy: linear
      next: lanes-parallel-end
  - id: code-prepare
    name: Prepare code fan-out dataset
    execution:
      kind: script
      script:
        package: research-scripts
        entry: workflow/code/prepare.mjs
        runtime: node20
    context_from:
      - start
    contracts:
      output:
        type: object
        required:
          - fanout_items
          - artefacts
        properties:
          fanout_items:
            type: array
            description: Список файлов кода для fan-out.
            items:
              $ref: "#/schemas/codeItem@1"
          artefacts:
            type: object
            properties:
              fanout_items_path:
                type: string
                description: Путь до JSON cо списком элементов fan-out.
                format: path
                x-path:
                  mode: output
                  resolve:
                    base: "{{workspace.references.STEP_WORKSPACE}}"
                    output: absolute
                  require_inside_root: "{{workspace.references.STEP_WORKSPACE}}"
                  require_type: file
                  require_exist: always
    workspace_contract:
      files:
        required:
          - glob: fanout/code-items.json
            expect:
              count: 1
            error: fanout/code-items.json не создан
          - glob: code-prepare.json
            expect:
              count: 1
            error: code-prepare.json не создан
          - glob: output.yaml
            expect:
              count: 1
            error: output.yaml отсутствует
    navigation:
      strategy: linear
      next: code-dispatch
  - id: code-dispatch
    context_from:
      - code-prepare
    navigation:
      strategy: fanout
      branches:
        foreach: fanout_items
        as: code_item
        next: code-process-file
  - id: code-process-file
    name: Process code file
    execution:
      kind: script
      script:
        package: research-scripts
        entry: workflow/code/process-file.mjs
        runtime: node20
    contracts:
      input:
        type: object
        required:
          - code_item
        properties:
          code_item:
            $ref: "#/schemas/codeItem@1"
      output:
        type: object
        required:
          - status
          - lane_id
          - file
          - metrics
          - checks
        properties:
          status:
            type: string
          lane_id:
            type: string
            const: code
          file:
            type: object
            required:
              - index
              - path
              - relative_path
              - extension
            properties:
              index:
                type: integer
              path:
                type: string
                format: path
                x-path:
                  mode: output
                  resolve:
                    base: "{{dirname inputs.code_item.path}}"
                    output: absolute
                  require_inside_root: "{{inputs.code_item.path}}"
                  require_type: file
                  require_exist: always
              absolute_path:
                type: string
                format: path
                x-path:
                  mode: output
                  resolve:
                    base: "{{dirname inputs.code_item.path}}"
                    output: absolute
                  require_inside_root: "{{inputs.code_item.path}}"
                  require_type: file
                  require_exist: always
              relative_path:
                type: string
              display_path:
                type: string
              extension:
                type: string
          metrics:
            type: object
            required:
              - size_bytes
              - recorded_size_bytes
            properties:
              size_bytes:
                type: integer
                minimum: 0
              recorded_size_bytes:
                type: integer
                minimum: 0
          checks:
            type: object
            required:
              - exists
              - size_mismatch
            properties:
              exists:
                type: boolean
              size_mismatch:
                type: boolean
          deviations:
            type: array
            items:
              type: object
              additionalProperties: true
    context_from:
      - start
      - code-prepare
    workspace_contract:
      files:
        required:
          - glob: code-process.json
            expect:
              count: 1
            error: code-process.json не создан
          - glob: output.yaml
            expect:
              count: 1
            error: output.yaml не создан
    workspace:
      references:
        override:
          PROJECT_ROOT:
            from: project_root
            label: PROJECT_ROOT (из inputs.project_root)
    navigation:
      strategy: linear
      next: code-collect
  - id: code-collect
    navigation:
      strategy: fanin
      next: code-summary
      merge: {}
  - id: code-summary
    name: Build code lane summary
    execution:
      kind: script
      script:
        package: research-scripts
        entry: workflow/code/summary.mjs
        runtime: node20
    context_from:
      - code-collect
      - code-prepare
      - start
    contracts:
      input:
        type: object
        required:
          - code_processed
        properties:
          code_processed:
            $ref: "#/schemas/processedDocumentList@1"
    workspace_contract:
      files:
        required:
          - glob: reports/code-summary.json
            expect:
              count: 1
            error: reports/code-summary.json не создан
          - glob: reports/code-summary.md
            expect:
              count: 1
            error: reports/code-summary.md не создан
          - glob: tmp/code-summary-output.json
            expect:
              count: 1
            error: tmp/code-summary-output.json не создан
          - glob: output.yaml
            expect:
              count: 1
            error: output.yaml отсутствует
    navigation:
      strategy: linear
  - id: docs-prepare
    name: Prepare docs fan-out dataset
    execution:
      kind: script
      script:
        package: research-scripts
        entry: workflow/docs/prepare.mjs
        runtime: node20
    context_from:
      - start
    contracts:
      output:
        type: object
        required:
          - fanout_items
          - artefacts
        properties:
          fanout_items:
            type: array
            description: Список файлов документации для fan-out.
            items:
              $ref: "#/schemas/docItem@1"
          artefacts:
            type: object
            properties:
              fanout_items_path:
                type: string
                description: Путь до JSON с doc-items.
                format: path
                x-path:
                  mode: output
                  resolve:
                    base: "{{workspace.references.STEP_WORKSPACE}}"
                    output: absolute
                  require_inside_root: "{{workspace.references.STEP_WORKSPACE}}"
                  require_type: file
                  require_exist: always
    workspace_contract:
      files:
        required:
          - glob: fanout/docs-items.json
            expect:
              count: 1
            error: fanout/docs-items.json не создан
          - glob: docs-prepare.json
            expect:
              count: 1
            error: docs-prepare.json не создан
          - glob: output.yaml
            expect:
              count: 1
            error: output.yaml отсутствует
    navigation:
      strategy: linear
      next: docs-dispatch
  - id: docs-dispatch
    context_from:
      - docs-prepare
    navigation:
      strategy: fanout
      branches:
        foreach: fanout_items
        as: doc_item
        next: docs-process-file
  - id: docs-process-file
    name: Process documentation file
    execution:
      kind: script
      script:
        package: research-scripts
        entry: workflow/docs/process-file.mjs
        runtime: node20
    contracts:
      input:
        type: object
        required:
          - doc_item
        properties:
          doc_item:
            $ref: "#/schemas/docItem@1"
      output:
        type: object
        required:
          - status
          - lane_id
          - file
          - checks
        properties:
          status:
            type: string
          lane_id:
            type: string
            const: docs
          file:
            type: object
            required:
              - index
              - path
              - relative_path
              - extension
            properties:
              index:
                type: integer
              path:
                type: string
                format: path
                x-path:
                  mode: output
                  resolve:
                    base: "{{dirname inputs.doc_item.path}}"
                    output: absolute
                  require_inside_root: "{{inputs.doc_item.path}}"
                  require_type: file
                  require_exist: always
              absolute_path:
                type: string
                format: path
                x-path:
                  mode: output
                  resolve:
                    base: "{{dirname inputs.doc_item.path}}"
                    output: absolute
                  require_inside_root: "{{inputs.doc_item.path}}"
                  require_type: file
                  require_exist: always
              relative_path:
                type: string
              display_path:
                type: string
              extension:
                type: string
              top_directory:
                type: string
          metrics:
            type: object
            properties:
              has_title:
                type: boolean
              title_line:
                type: string
          checks:
            type: object
            required:
              - exists
            properties:
              exists:
                type: boolean
          deviations:
            type: array
            items:
              type: object
              additionalProperties: true
    context_from:
      - start
      - docs-prepare
    workspace_contract:
      files:
        required:
          - glob: docs-process.json
            expect:
              count: 1
            error: docs-process.json не создан
          - glob: output.yaml
            expect:
              count: 1
            error: output.yaml не создан
    workspace:
      references:
        override:
          PROJECT_ROOT:
            from: project_root
            label: PROJECT_ROOT (из inputs.project_root)
    navigation:
      strategy: linear
      next: docs-collect
  - id: docs-collect
    navigation:
      strategy: fanin
      next: docs-summary
      merge:
        into: docs_processed
        includeErrors: true
  - id: docs-summary
    name: Build documentation lane summary
    execution:
      kind: script
      script:
        package: research-scripts
        entry: workflow/docs/summary.mjs
        runtime: node20
    context_from:
      - docs-collect
      - docs-prepare
      - start
    contracts:
      input:
        type: object
        required:
          - docs_processed
        properties:
          docs_processed:
            $ref: "#/schemas/processedDocumentList@1"
    workspace_contract:
      files:
        required:
          - glob: reports/doc-summary.json
            expect:
              count: 1
            error: reports/doc-summary.json не создан
          - glob: reports/doc-summary.md
            expect:
              count: 1
            error: reports/doc-summary.md не создан
          - glob: tmp/doc-summary-output.json
            expect:
              count: 1
            error: tmp/doc-summary-output.json не создан
          - glob: output.yaml
            expect:
              count: 1
            error: output.yaml отсутствует
    navigation:
      strategy: linear
  - id: lanes-parallel-end
    kind: parallel
    mode: end
    block: lanes-processing
    join:
      strategy: wait_all
      merge:
        into: parallel_results
        includeErrors: true
        includeMetadata: true
        keyBy: lane_id
    contracts:
      output:
        type: object
        required:
          - parallel_results
        properties:
          parallel_results:
            $ref: "#/schemas/parallelResults@1"
    context_from:
      - start
    navigation:
      strategy: linear
      next: lanes-summary
  - id: code-persist
    name: Persist code lane results
    execution:
      kind: script
      script:
        package: research-scripts
        entry: workflow/code/persist.mjs
        runtime: node20
    context_from:
      - lanes-summary
      - start
    workspace_contract:
      files:
        required:
          - glob: global/analysis/code-ingest.jsonl
            expect:
              count: 1
            error: analysis/code-ingest.jsonl не создан
          - glob: output.yaml
            expect:
              count: 1
            error: output.yaml отсутствует
    navigation:
      strategy: linear
      next: final-report
  - id: lanes-summary
    name: Consolidate lane metrics
    execution:
      kind: script
      script:
        package: research-scripts
        entry: workflow/lanes/summary.mjs
        runtime: node20
    context_from:
      - lanes-parallel-end
      - start
    contracts:
      input:
        type: object
        required:
          - parallel_results
        properties:
          parallel_results:
            $ref: "#/schemas/parallelResults@1"
    workspace_contract:
      files:
        required:
          - glob: reports/combined-summary.json
            expect:
              count: 1
            error: reports/combined-summary.json не создан
          - glob: tmp/lanes-summary-output.json
            expect:
              count: 1
            error: tmp/lanes-summary-output.json не создан
          - glob: output.yaml
            expect:
              count: 1
            error: output.yaml отсутствует
    navigation:
      strategy: linear
      next: code-persist
  - id: final-report
    name: Generate structure report
    execution:
      kind: script
      script:
        package: research-scripts
        entry: workflow/report/structure.mjs
        runtime: node20
    context_from:
      - lanes-summary
      - start
    workspace_contract:
      files:
        required:
          - glob: global/reports/structure.md
            expect:
              count: 1
            error: structure.md не создан
          - glob: output.yaml
            expect:
              count: 1
            error: output.yaml отсутствует
    navigation:
      strategy: linear
